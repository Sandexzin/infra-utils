# ============================================
# ğŸ–¥ï¸ RDP via Docker + AnyDesk AutoConnect
# ğ”°ğ”¦ğ”µâ›§ğ”±ğ”¢ğ”ğ”ª edition ğŸ˜ˆ
# ============================================

name: RDP-AnyDesk

on:
  workflow_dispatch:

env:
  # ============================================
  # ğŸ” VARIÃVEIS DE AMBIENTE (.env interno)
  # ============================================
  WINDOWS_USERNAME: "Sixteam"
  WINDOWS_PASSWORD: "six@123"
  RAM_SIZE: "10G"
  CPU_CORES: "4"
  WINDOWS_VERSION: "10"
  # ============================================

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: ğŸ”¹ Preparando ambiente
      run: |
        sudo apt update
        sudo apt install -y docker.io curl wget unzip net-tools

    - name: ğŸ³ Iniciando Windows (Dockurr)
      run: |
        echo "ğŸš€ Iniciando container Windows..."
        docker run -d --name windows \
          --privileged \
          --restart always \
          --cap-add NET_ADMIN \
          -e VERSION="${WINDOWS_VERSION}" \
          -e USERNAME="${WINDOWS_USERNAME}" \
          -e PASSWORD="${WINDOWS_PASSWORD}" \
          -e RAM_SIZE="${RAM_SIZE}" \
          -e CPU_CORES="${CPU_CORES}" \
          -p 3389:3389 \
          -p 8006:8006 \
          -v /tmp/docker-data:/mnt/disco1 \
          -v windows-data:/mnt/windows-data \
          dockurr/windows

    - name: â³ Aguardando inicializaÃ§Ã£o do Windows
      run: |
        echo "â³ Aguardando 2 minutos para inicializaÃ§Ã£o..."
        sleep 120

    - name: ğŸ“¦ Instalando e configurando AnyDesk
      run: |
        echo "ğŸ“¥ Baixando AnyDesk..."
        docker exec windows powershell -Command "Invoke-WebRequest -Uri 'https://download.anydesk.com/AnyDesk.exe' -OutFile 'C:\\AnyDesk.exe'"
        
        echo "âš™ï¸ Instalando AnyDesk silenciosamente..."
        docker exec windows powershell -Command "Start-Process 'C:\\AnyDesk.exe' -ArgumentList '/install /silent' -Wait"
        
        echo "ğŸ”§ Ativando modo acesso automÃ¡tico..."
        docker exec windows powershell -Command "Set-ItemProperty -Path 'HKLM:\\SOFTWARE\\AnyDesk' -Name 'ad.anynet.autostart' -Value 1"
        docker exec windows powershell -Command "Set-ItemProperty -Path 'HKLM:\\SOFTWARE\\AnyDesk' -Name 'ad.security.accepted' -Value 1"
        docker exec windows powershell -Command "Set-ItemProperty -Path 'HKLM:\\SOFTWARE\\AnyDesk' -Name 'ad.security.password' -Value (ConvertTo-SecureString '${WINDOWS_PASSWORD}' -AsPlainText -Force)"
        docker exec windows powershell -Command "Restart-Service AnyDesk"
        
        echo "âœ… AnyDesk instalado e configurado com aceitaÃ§Ã£o automÃ¡tica."

    - name: ğŸ” Exibindo ID do AnyDesk
      run: |
        echo "ğŸ” Obtendo ID do AnyDesk..."
        docker exec windows powershell -Command "Start-Sleep -Seconds 15; & 'C:\\Program Files (x86)\\AnyDesk\\AnyDesk.exe' --get-id" || echo "âš ï¸ Ainda inicializando, aguarde mais alguns segundos e recarregue os logs."

    - name: ğŸ§  InformaÃ§Ãµes de ConexÃ£o
      run: |
        echo ""
        echo "======================================"
        echo " ğŸ–¥ï¸ CONEXÃƒO ANYDESK DISPONÃVEL "
        echo "======================================"
        echo "ğŸ‘¤ UsuÃ¡rio: ${WINDOWS_USERNAME}"
        echo "ğŸ”‘ Senha:   ${WINDOWS_PASSWORD}"
        echo "ğŸ“¡ ID: (ver acima â¬†ï¸)"
        echo "âš™ï¸ Acesso automÃ¡tico ativado (sem precisar aceitar)."
        echo "âš ï¸ Aguarde ~1â€“2 minutos apÃ³s o log para o ID estar 100% ativo."
        echo "======================================"
